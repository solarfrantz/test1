version: 2
jobs:
  build:
    context: nova-assets
    working_directory: ~/workdir
    machine: true
    steps:
    
      - run:
          name: Clone repository
          command: |
            git clone https://${DOCS_GITHUB_TOKEN}@github.com/solarfrantz/${CIRCLE_PROJECT_REPONAME}.git .

      - run:
          name: Download resources
          command: |
            cd icons
            rm -f *
            git checkout package.json
            
            wget -q ${ICOMOON_URL}/selection-svg.json
            
            # checking for any changes
            GIT_CHANGES=`git status --porcelain --untracked-files=no | wc -l`
            if [ $GIT_CHANGES -eq 0 ] ; then
                echo "No resources changed"
                circleci-agent step halt
            else
                echo "Found the following $GIT_CHANGES change(s)"
                git status
                
                npm version patch
                git add .
            fi

      - run:
          name: npm pack & publish
          command: |
            cd icons
            npm pack

            # authenticate with npmjs token
            echo "//registry.npmjs.org/:_authToken=${NPMJS_TOKEN}" > .npmrc
            
            # npm login --registry=https://npm.pkg.github.com
            npm publish

      - deploy:
          name: Trigger deployment
          command: |
            git config credential.helper 'cache --timeout=120'
            git config user.email "francisc.ungureanu@solarwinds.com"
            git config user.name "solarfrantz"
            git commit -m "Trigger deployment"
            # Push quietly to prevent showing the token in log
            git push -q https://${DOCS_GITHUB_TOKEN}@github.com/solarfrantz/${CIRCLE_PROJECT_REPONAME}.git ${CIRCLE_BRANCH}
